name: Process Hangout Text Files

on:
  push:
    branches: [main]
    paths:
      - 'hs_hangout/*.txt'

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Detect new hangout text files
        id: detect
        run: |
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 -- 'hs_hangout/*.txt' || true)
          if [ -z "$NEW_FILES" ]; then
            echo "No new text files detected."
            echo "has_new_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "New files detected:"
            echo "$NEW_FILES"
            echo "has_new_files=true" >> "$GITHUB_OUTPUT"
            echo "files<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NEW_FILES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Parse new hangout files
        if: steps.detect.outputs.has_new_files == 'true'
        run: |
          while IFS= read -r file; do
            echo "Processing: $file"
            basename=$(basename "$file")
            if [[ "$basename" =~ FNPHangoutText[A-Za-z]*([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{2})\.txt ]]; then
              month="${BASH_REMATCH[1]}"
              day="${BASH_REMATCH[2]}"
              year="20${BASH_REMATCH[3]}"
              date_str=$(printf "%s_%02d_%02d" "$year" "$month" "$day")
              echo "  Date: $date_str"
              python parse_hangout_text.py --file "$file" --date "$date_str"
            else
              echo "  WARNING: Could not extract date from $basename, skipping"
            fi
          done <<< "${{ steps.detect.outputs.files }}"

      - name: Regenerate data.js and embeds
        if: steps.detect.outputs.has_new_files == 'true'
        run: python generate_data_js.py

      - name: Commit and push
        if: steps.detect.outputs.has_new_files == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ docs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update: Process new hangout data [skip ci]"
            git push
          fi
